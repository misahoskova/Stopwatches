<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Historie stopek</title>
    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
    <!-- Font Awesome pro ikonky -->
    <script defer src="https://use.fontawesome.com/releases/v5.15.4/js/all.js"></script>
  </head>
  <body>
    <section class="section">
      <div class="container">
        <h1 class="title">Record history</h1>

        <table class="table is-striped is-fullwidth">
          <thead>
            <tr>
              <th>ID</th>
              <th>Start</th>
              <th>End</th>
              <th>Duration</th>
              <th>Description</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (entries && entries.length) { %> <% entries.forEach((entry) => { %>
            <tr>
              <td><%= entry.id %></td>
              <td><%= entry.start %></td>
              <td><%= entry.end %></td>
              <td><%= entry.duration %></td>
              <td><%= entry.description %></td>
              <td>
                <!-- Edit: zobrazí detail pro úpravu -->
                <a href="/api/stopwatch/entry/<%= entry.id %>/edit" class="button is-small is-info" title="Upravit">
                  <span class="icon"><i class="fas fa-edit"></i></span>
                </a>

                <!-- Delete: vyžádá potvrzení, pak smaže -->
                <form
                  action="/api/stopwatch/entry/<%= entry.id %>/delete"
                  method="post"
                  style="display: inline"
                  onsubmit="return confirm('Opravdu smazat záznam #<%= entry.id %>?');"
                >
                  <input type="hidden" id="entryId" name="entryId" />
                  <button class="button is-small is-danger" title="Smazat">
                    <span class="icon"><i class="fas fa-trash"></i></span>
                  </button>
                </form>

                <!-- Send: nic zatím neprovádí -->
                <button
                  class="button is-small is-warning send-button"
                  onclick="openSendModal('<%= entry.id %>')"
                  title="Odeslat"
                >
                  <span class="icon"><i class="fas fa-paper-plane"></i></span>
                </button>
              </td>
            </tr>
            <% }) %> <% } else { %>
            <tr>
              <td colspan="6" class="has-text-centered">No records</td>
            </tr>
            <% } %>
          </tbody>
        </table>

        <div class="modal" id="sendModal">
          <div class="modal-background" onclick="closeSendModal()"></div>
          <div class="modal-content box">
            <form id="sendForm">
              <div class="field">
                <label class="label">Vyber firmu</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="companySelect" required>
                      <option value="">-- Vyber firmu --</option>
                      <option value="PRUSA">Prusa Development a.s.</option>
                      <option value="PRUSA0">Prusa Polymers a.s.</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="buttons mt-4">
                <button class="button is-success" type="submit">Odeslat</button>
                <button type="button" class="button" onclick="closeSendModal()">Zrušit</button>
              </div>
            </form>
          </div>
        </div>

        <a href="/" class="button is-link">Back to stopwatch</a>
      </div>
    </section>
  </body>

  <script>
    let currentEntryId = null

    function openSendModal(entryId) {
      currentEntryId = entryId
      document.getElementById('sendModal').classList.add('is-active')
    }

    function closeSendModal() {
      currentEntryId = null
      document.getElementById('sendModal').classList.remove('is-active')
    }

    async function validateCompanySelection(event) {
      event.preventDefault()
      const company = document.getElementById('companySelect').value

      if (!company || !currentEntryId) {
        alert('Musíte vybrat firmu!')
        return
      }

      try {
        const response = await fetch(`/api/stopwatch/send/${currentEntryId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ company }),
        })

        const data = await response.json()

        if (response.ok) {
          alert('Záznam úspěšně odeslán!')
        } else {
          alert('Chyba při odesílání: ' + data.error)
          console.error(data)
        }
      } catch (err) {
        alert('Chyba při komunikaci se serverem.')
        console.error(err)
      }

      closeSendModal()
    }

    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('sendForm')
      if (form) {
        form.addEventListener('submit', validateCompanySelection)
      }
    })
  </script>
</html>
